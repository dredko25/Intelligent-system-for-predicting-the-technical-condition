<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>–ì—Ä–∞—Ñ—ñ–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—é</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
            transition: background-color 0.5s ease;
        }

        .chart-container.normal {
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }

        .chart-container.warning {
            background: linear-gradient(135deg, #fff8f0 0%, #fff0e0 100%);
        }

        .chart-container.critical {
            background: linear-gradient(135deg, #fff0f0 0%, #ffe0e0 100%);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .device-info {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #0056b3;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .update-time {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        .threshold-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .critical-value {
            color: #dc3545;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-normal {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-critical {
            background-color: #dc3545;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–∞–Ω–µ–ª—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è */
        .control-panel {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .scenario-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .scenario-button {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .scenario-button:hover {
            background: #5a6268;
        }

        .scenario-button.active {
            background: #28a745;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <div id="connection-status" class="connection-status">
        –û–Ω–æ–≤–ª–µ–Ω–Ω—è: –ê–∫—Ç–∏–≤–Ω–µ
    </div>

    <div class="container">
        <button class="back-button" onclick="window.history.back()">‚Üê –ù–∞–∑–∞–¥</button>

        <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
        <div class="control-panel">
            <div class="control-title">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä–æ—î–º</div>

            <div class="scenario-selector">
                <span>–°—Ü–µ–Ω–∞—Ä—ñ—ó:</span>
                <button class="scenario-button" data-scenario="normal" onclick="changeScenario('normal')">–ù–æ—Ä–º–∞–ª—å–Ω–∏–π
                    —Å—Ç–∞–Ω</button>
                <button class="scenario-button" data-scenario="twf" onclick="changeScenario('twf')">–ó–Ω–æ—Å
                    —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É</button>
                <button class="scenario-button" data-scenario="hdf" onclick="changeScenario('hdf')">–ü—Ä–æ–±–ª–µ–º–∞
                    —Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω—É</button>
                <button class="scenario-button" data-scenario="pwf" onclick="changeScenario('pwf')">–ü—Ä–æ–±–ª–µ–º–∏ –∑
                    –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—é</button>
                <button class="scenario-button" data-scenario="osf"
                    onclick="changeScenario('osf')">–ü–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</button>
                <button class="scenario-button" data-scenario="rnf" onclick="changeScenario('rnf')">–í–∏–ø–∞–¥–∫–æ–≤–∞
                    –≤—ñ–¥–º–æ–≤–∞</button>
                <button class="scenario-button" data-scenario="worn_stress"
                    onclick="changeScenario('worn_stress')">–°—Ç–∞—Ä–µ/–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</button>
            </div>
        </div>

        <div class="device-info">
            <h2>–ì—Ä–∞—Ñ—ñ–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—é: <span id="device-uid"></span></h2>
            <p>–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç—É: <span id="product-type"></span></p>
            <p>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π: <span id="current-scenario">-</span></p>
            <p class="update-time">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <span id="last-update">-</span></p>
        </div>

        <div class="control-panel" id="history-panel" style="display: none;">
            <div class="control-title">–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</div>
            <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                <div>
                    <label class="small text-muted">–í—ñ–¥:</label>
                    <input type="datetime-local" id="start-date" class="form-control">
                </div>
                <div>
                    <label class="small text-muted">–î–æ:</label>
                    <input type="datetime-local" id="end-date" class="form-control">
                </div>
                <button onclick="loadHistory()" class="back-button" style="margin: 0; background: #6c757d;">
                    –ì—Ä–∞—Ñ—ñ–∫
                </button>
                <button onclick="downloadHistoryCSV()" class="back-button" style="margin: 0; background: #0d6efd;">
                    CSV
                </button>
                <button onclick="resetToLive()" class="back-button" style="margin: 0; background: #28a745;">
                    Live
                </button>
            </div>
        </div>

        <div class="chart-container normal" id="airTempChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ñ—Ç—Ä—è</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 296-304 K | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: >306K –∞–±–æ <294
                        K</span>
            </div>
            <canvas id="airTempChart"></canvas>
        </div>

        <div class="chart-container normal" id="processTempChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—É</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 308-312 K | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: >314K –∞–±–æ <306
                        K</span>
            </div>
            <canvas id="processTempChart"></canvas>
        </div>

        <div class="chart-container normal" id="speedChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±–µ—Ä—Ç–∞–Ω–Ω—è</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 1380-2500 RPM | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: <1380 –∞–±–æ>2500
                        RPM</span></div>
            <canvas id="speedChart"></canvas>
        </div>

        <div class="chart-container normal" id="torqueChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–ö—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 30-50 Nm | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: <20 –∞–±–æ>60 Nm</span>
            </div>
            <canvas id="torqueChart"></canvas>
        </div>

        <div class="chart-container normal" id="wearChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–ó–Ω–æ—Å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 0-180 units | –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: 180-240 units | <span
                    class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: ‚â•240 units (TWF)</span></div>
            <canvas id="wearChart"></canvas>
        </div>

        <div class="chart-container normal" id="powerChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: 3500-9000 W | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: <3000 –∞–±–æ>10000 W
                        (PWF)</span></div>
            <canvas id="powerChart"></canvas>
        </div>

        <div class="chart-container normal" id="tempDiffChart-container">
            <div class="chart-title"><span class="status-indicator status-normal"></span>–†—ñ–∑–Ω–∏—Ü—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä (t –ø—Ä–æ—Ü–µ—Å—É -
                t –ø–æ–≤—ñ—Ç—Ä—è)</div>
            <div class="threshold-info">–ù–æ—Ä–º–∞: >8.6¬∞C | <span class="critical-value">–ö—Ä–∏—Ç–∏—á–Ω–æ: ‚â§8.6¬∞C (HDF)</span></div>
            <canvas id="tempDiffChart"></canvas>
        </div>
    </div>

    <script>
        // –û–±–º–µ–∂–µ–Ω–Ω—è –∑ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
        const thresholds = {
            // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ñ—Ç—Ä—è: 300K ¬± 2œÉ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è 2K)
            // –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: 296-304K (95% –¥–∞–Ω–∏—Ö)
            // –ö—Ä–∏—Ç–∏—á–Ω–æ: –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ 3œÉ (>306K –∞–±–æ <294K)
            air_temp: {
                normal_min: 296,      // 300 - 2*2
                normal_max: 304,      // 300 + 2*2
                critical_low: 294,    // 300 - 3*2
                critical_high: 306    // 300 + 3*2
            },

            // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—É: air_temp + 10K ¬± 1œÉ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è 1K)
            // –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: 308-312K
            // –ö—Ä–∏—Ç–∏—á–Ω–æ: >314K –∞–±–æ <306K
            process_temp: {
                normal_min: 308,      // 310 - 2*1
                normal_max: 312,      // 310 + 2*1
                critical_low: 306,    // 310 - 4*1
                critical_high: 314    // 310 + 4*1
            },

            // –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±–µ—Ä—Ç–∞–Ω–Ω—è:
            // –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è HDF: < 1380 rpm (–ø—Ä–∏ –º–∞–ª—ñ–π —Ä—ñ–∑–Ω–∏—Ü—ñ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä)
            // –î—ñ–∞–ø–∞–∑–æ–Ω —É –¥–∞—Ç–∞—Å–µ—Ç—ñ: ~1200-2800 rpm
            rotational_speed: {
                normal_min: 1380,     // –ü–æ—Ä—ñ–≥ –¥–ª—è HDF
                normal_max: 2500,
                critical_low: 1380,   // HDF —É–º–æ–≤–∞
                critical_high: 2800   // –ú–∞–∫—Å–∏–º—É–º
            },

            // –ö—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç: –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª –Ω–∞–≤–∫–æ–ª–æ 40Nm, SD=10Nm
            // –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: 30-50Nm (1œÉ)
            // –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è OSF: –≤ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –∑ tool_wear
            torque: {
                normal_min: 30,       // 40 - 10
                normal_max: 50,       // 40 + 10
                critical_low: 20,     // 40 - 2*10
                critical_high: 60     // 40 + 2*10
            },

            // –ó–Ω–æ—Å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É:
            // TWF: 200-240 —Ö–≤–∏–ª–∏–Ω (–º–æ–∂–µ –≤–∏–π—Ç–∏ –∑ –ª–∞–¥—É –∞–±–æ –±—É—Ç–∏ –∑–∞–º—ñ–Ω–µ–Ω–æ)
            tool_wear: {
                normal_max: 180,      // –ù–æ—Ä–º–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞
                warning: 200,         // –ü–æ—á–∞—Ç–æ–∫ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É TWF
                critical: 240         // –ú–∞–∫—Å–∏–º—É–º –ø–µ—Ä–µ–¥ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º –∑–±–æ—î–º
            },

            // –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å: Torque √ó Speed (–ë–ï–ó –∫–æ–Ω–≤–µ—Ä—Å—ñ—ó rad/s —É –¥–∞—Ç–∞—Å–µ—Ç—ñ!)
            // PWF: < 3500W –∞–±–æ > 9000W
            power: {
                normal_min: 3500,
                normal_max: 9000,
                critical_low: 3500,   // PWF —É–º–æ–≤–∞ (–º–µ–Ω—à–µ)
                critical_high: 9000   // PWF —É–º–æ–≤–∞ (–±—ñ–ª—å—à–µ)
            },

            // –†—ñ–∑–Ω–∏—Ü—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä (Process - Air):
            // HDF: < 8.6K (–ø—Ä–∏ —à–≤–∏–¥–∫–æ—Å—Ç—ñ < 1380 rpm)
            temp_difference: {
                normal_min: 8.6,      // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ —Ä—ñ–∑–Ω–∏—Ü—è
                critical: 8.6,        // HDF —É–º–æ–≤–∞ (–º–µ–Ω—à–µ –∞–±–æ –¥–æ—Ä—ñ–≤–Ω—é—î)
                warning: 9.0          // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ
            },

            // –î–æ–¥–∞—Ç–∫–æ–≤–æ: OSF (Overstrain) - –¥–æ–±—É—Ç–æ–∫ tool_wear √ó torque
            // L –≤–∞—Ä—ñ–∞–Ω—Ç: > 11,000 minNm
            // M –≤–∞—Ä—ñ–∞–Ω—Ç: > 12,000 minNm  
            // H –≤–∞—Ä—ñ–∞–Ω—Ç: > 13,000 minNm
            overstrain: {
                L: { critical: 11000 },
                M: { critical: 12000 },
                H: { critical: 13000 }
            }
        };

        // –ù–∞–∑–≤–∏ —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const scenarioNames = {
            normal: "–ù–æ—Ä–º–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω",
            twf: "–ó–Ω–æ—Å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É",
            hdf: "–ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–ø–ª–æ–æ–±–º—ñ–Ω—É",
            pwf: "–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ",
            osf: "–ü–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è",
            rnf: "–í–∏–ø–∞–¥–∫–æ–≤–∞ –≤—ñ–¥–º–æ–≤–∞",
            worn_stress: "–°—Ç–∞—Ä–µ –ø—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º"
        };

        let deviceUid = new URLSearchParams(window.location.search).get('device');
        if (!deviceUid) {
            deviceUid = 'dev-1';
        }

        document.getElementById('device-uid').textContent = deviceUid;

        // –ö–æ–ª—ñ—Ä–Ω–∞ —Å—Ö–µ–º–∞
        const colors = {
            primary: 'rgba(54, 162, 235, 0.8)',
            warning: 'rgba(255, 159, 64, 0.8)',
            critical: 'rgba(255, 99, 132, 0.8)',
            criticalBg: 'rgba(255, 99, 132, 0.1)',
            warningBg: 'rgba(255, 159, 64, 0.1)'
        };

        let charts = {};
        let ws = null;
        let chartStatus = {};
        let currentScenario = 'normal';

        function downloadHistoryCSV() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;

            let url = `/api/export/history/${deviceUid}`;

            // –Ø–∫—â–æ –¥–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ - –¥–æ–¥–∞—î–º–æ —ó—Ö —É –∑–∞–ø–∏—Ç
            if (start && end) {
                url += `?start_date=${start}&end_date=${end}`;
            } else {
                // –Ø–∫—â–æ –¥–∞—Ç–∏ –Ω–µ –≤–∏–±—Ä–∞–Ω—ñ, –ø–∏—Ç–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                if (!confirm("–î–∞—Ç–∏ –Ω–µ –æ–±—Ä–∞–Ω–æ. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é (–æ—Å—Ç–∞–Ω–Ω—ñ 5000 –∑–∞–ø–∏—Å—ñ–≤)?")) {
                    return;
                }
            }

            // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è, —â–æ–± –ø–æ—á–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            window.location.href = url;
        }

        // =============================================
        // –§–£–ù–ö–¶–Ü–á –ö–ï–†–£–í–ê–ù–ù–Ø –ü–†–ò–°–¢–†–û–Ñ–ú
        // =============================================

        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendCommand(action, scenario = null) {
            try {
                const command = {
                    device_uid: deviceUid,
                    action: action
                };

                if (scenario) {
                    command.scenario = scenario;
                }

                const response = await fetch('/api/device/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(command)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    if (scenario) {
                        updateScenarioDisplay(scenario);
                    }
                    console.log('–ö–æ–º–∞–Ω–¥—É –≤–∏–∫–æ–Ω–∞–Ω–æ:', action, scenario);
                } else {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', result.message);
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + result.message);
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–≤\'—è–∑–∫—É:', error);
            }
        }

        // –ó–º—ñ–Ω–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—é
        function changeScenario(scenario) {
            currentScenario = scenario;
            sendCommand('change_scenario', scenario);
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é
        function updateScenarioDisplay(scenario) {
            document.getElementById('current-scenario').textContent = scenarioNames[scenario] || scenario;

            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É —Å—Ü–µ–Ω–∞—Ä—ñ—é
            document.querySelectorAll('.scenario-button').forEach(button => {
                if (button.dataset.scenario === scenario) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // =============================================
        // WebSocket —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫–∏
        // =============================================

        // WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É
        function connectWebSocket() {
            const statusElement = document.getElementById('connection-status');

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/api/ws/live`;

                ws = new WebSocket(wsUrl);

                ws.onopen = function (event) {
                    console.log('WebSocket connected for charts');
                    statusElement.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è: –ê–∫—Ç–∏–≤–Ω–µ';
                    statusElement.className = 'connection-status';
                };

                ws.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'live_data' && data.device_uid === deviceUid) {

                            const sentTime = new Date(data.timestamp).getTime();
                            const now = new Date().getTime();
                            const latency = now - sentTime;
                            console.log("End-to-End Latency:", latency, "ms");

                            updateChartsWithNewData(data);

                            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ü–µ–Ω–∞—Ä—ñ–π
                            if (data.scenario && data.scenario !== currentScenario) {
                                currentScenario = data.scenario;
                                updateScenarioDisplay(data.scenario);
                            }
                        }
                    } catch (e) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞–Ω–∏—Ö:', e);
                    }
                };

                ws.onclose = function (event) {
                    console.log('WebSocket disconnected for charts');
                    statusElement.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è: –í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                    statusElement.className = 'connection-status disconnected';

                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    statusElement.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è: –ü–æ–º–∏–ª–∫–∞';
                    statusElement.className = 'connection-status disconnected';
                };

            } catch (error) {
                console.error('Failed to create WebSocket:', error);
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –∑ –Ω–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏
        function updateChartsWithNewData(data) {
            if (Object.keys(charts).length === 0) {
                console.log('–ì—Ä–∞—Ñ—ñ–∫–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω—ñ');
                return;
            }

            const timestamp = new Date().toLocaleTimeString();

            document.getElementById('last-update').textContent = timestamp;

            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
            updateChartWithThresholds(charts.airTempChart, timestamp, data.air_temp, 'air_temp');
            updateChartWithThresholds(charts.processTempChart, timestamp, data.process_temp, 'process_temp');
            updateChartWithThresholds(charts.speedChart, timestamp, data.rotational_speed, 'rotational_speed');
            updateChartWithThresholds(charts.torqueChart, timestamp, data.torque, 'torque');
            updateChartWithThresholds(charts.wearChart, timestamp, data.tool_wear, 'tool_wear');

            // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏
            const power = data.torque * data.rotational_speed * 2 * 3.14159 / 60;
            const tempDiff = data.process_temp - data.air_temp;

            updateChartWithThresholds(charts.powerChart, timestamp, power, 'power');
            updateChartWithThresholds(charts.tempDiffChart, timestamp, tempDiff, 'temp_difference');
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ø–æ—Ä–æ–≥—ñ–≤
        function updateChartWithThresholds(chart, timestamp, value, metricType) {
            if (!chart) return;

            // –û–±–º–µ–∂—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫
            if (chart.data.labels.length > 30) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.data.labels.push(timestamp);
            chart.data.datasets[0].data.push(value);

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
            const threshold = thresholds[metricType];
            let status = 'normal';

            if (threshold) {
                if (threshold.critical !== undefined) {
                    if (metricType === 'temp_difference') {
                        if (value <= threshold.critical) status = 'critical';
                    } else {
                        if (value >= threshold.critical) status = 'critical';
                    }
                } else if (threshold.critical_low !== undefined && threshold.critical_high !== undefined) {
                    if (value <= threshold.critical_low || value >= threshold.critical_high) {
                        status = 'critical';
                    }
                }

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –¥–ª—è –∑–Ω–æ—Å—É
                if (metricType === 'tool_wear' && value >= threshold.warning && value < threshold.critical) {
                    status = 'warning';
                }
            }

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ü—å–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞
            chartStatus[metricType] = status;

            // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä –ª—ñ–Ω—ñ—ó —Ç–∞ —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            updateChartAppearance(chart, metricType, status, value);

            chart.update('none');
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–≥–ª—è–¥—É –≥—Ä–∞—Ñ—ñ–∫–∞
        function updateChartAppearance(chart, metricType, status, value) {
            const containerId = chart.canvas.id + '-container';
            const container = document.getElementById(containerId);
            const statusIndicator = container.querySelector('.status-indicator');

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            container.className = `chart-container ${status}`;

            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å—É
            statusIndicator.className = `status-indicator status-${status}`;

            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–ª—ñ—Ä –ª—ñ–Ω—ñ—ó –≥—Ä–∞—Ñ—ñ–∫–∞
            switch (status) {
                case 'critical':
                    chart.data.datasets[0].borderColor = colors.critical;
                    chart.data.datasets[0].pointBackgroundColor = colors.critical;
                    chart.data.datasets[0].backgroundColor = colors.criticalBg;
                    break;
                case 'warning':
                    chart.data.datasets[0].borderColor = colors.warning;
                    chart.data.datasets[0].pointBackgroundColor = colors.warning;
                    chart.data.datasets[0].backgroundColor = colors.warningBg;
                    break;
                default:
                    chart.data.datasets[0].borderColor = colors.primary;
                    chart.data.datasets[0].pointBackgroundColor = colors.primary;
                    chart.data.datasets[0].backgroundColor = 'rgba(54, 162, 235, 0.1)';
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        async function loadInitialChartsData() {
            // 1. –°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫–∏ (–ø–æ—Ä–æ–∂–Ω—ñ)
            createChartsWithThresholds();

            try {
                const response = await fetch(`/api/device/${deviceUid}/charts`);
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('product-type').textContent = data.product_type || '–ù–µ–≤—ñ–¥–æ–º–æ';

                    if (data.scenario) {
                        currentScenario = data.scenario;
                        updateScenarioDisplay(data.scenario);
                    }

                    // 2. –ó–ê–ü–û–í–ù–Æ–Ñ–ú–û –ì–†–ê–§–Ü–ö–ò –Ü–°–¢–û–†–Ü–Ñ–Æ
                    if (data.charts) {
                        // –ö–∞—Ä—Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –∫–ª—é—á—ñ–≤ API –¥–æ –æ–±'—î–∫—Ç—ñ–≤ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
                        const chartMapping = {
                            'air_temp': 'airTempChart',
                            'process_temp': 'processTempChart',
                            'rotational_speed': 'speedChart',
                            'torque': 'torqueChart',
                            'tool_wear': 'wearChart',
                            'power': 'powerChart',
                            'temp_difference': 'tempDiffChart'
                        };

                        // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –≤—Å—ñ—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö
                        for (const [apiKey, chartName] of Object.entries(chartMapping)) {
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –¥–∞–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞
                            if (data.charts[apiKey] && charts[chartName]) {
                                const historicalData = data.charts[apiKey].data;

                                // –î–æ–¥–∞—î–º–æ —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫
                                historicalData.forEach(point => {
                                    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —á–∞—Å —É —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç, —è–∫ —É live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ
                                    const timeLabel = new Date(point.x).toLocaleTimeString();

                                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á—É —Ñ—É–Ω–∫—Ü—ñ—é, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–≥—ñ–∫—É –∫–æ–ª—å–æ—Ä—ñ–≤ (—á–µ—Ä–≤–æ–Ω–∏–π/–∑–µ–ª–µ–Ω–∏–π)
                                    updateChartWithThresholds(charts[chartName], timeLabel, point.y, apiKey);
                                });

                                charts[chartName].update();
                            }
                        }
                        console.log('–Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
                    }
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
                document.getElementById('product-type').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            }
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
        function createChartsWithThresholds() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function (context) {
                                const value = context.raw;
                                const datasetIndex = context.datasetIndex;
                                let status = 'üü¢ –ù–æ—Ä–º–∞';

                                if (datasetIndex === 0) {
                                    const chartId = context.chart.canvas.id;

                                    // –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É –≥—Ä–∞—Ñ—ñ–∫–∞
                                    if (chartId === 'wearChart') {
                                        if (value >= thresholds.tool_wear.critical) status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û (TWF)';
                                        else if (value >= thresholds.tool_wear.warning) status = 'üü° –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è';

                                    } else if (chartId === 'tempDiffChart') {
                                        if (value <= thresholds.temp_difference.critical) status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û (HDF)';

                                    } else if (chartId === 'powerChart') {
                                        if (value <= thresholds.power.critical_low || value >= thresholds.power.critical_high)
                                            status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û (PWF)';

                                    } else if (chartId === 'airTempChart') {
                                        if (value <= thresholds.air_temp.critical_low || value >= thresholds.air_temp.critical_high)
                                            status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û';

                                    } else if (chartId === 'processTempChart') {
                                        if (value <= thresholds.process_temp.critical_low || value >= thresholds.process_temp.critical_high)
                                            status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û';

                                    } else if (chartId === 'speedChart') {
                                        if (value <= thresholds.rotational_speed.critical_low || value >= thresholds.rotational_speed.critical_high)
                                            status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û';

                                    } else if (chartId === 'torqueChart') {
                                        if (value <= thresholds.torque.critical_low || value >= thresholds.torque.critical_high)
                                            status = 'üî¥ –ö–†–ò–¢–ò–ß–ù–û';
                                    }
                                }
                                return `–°—Ç–∞—Ç—É—Å: ${status}`;
                            }
                        }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: '–ß–∞—Å' } },
                    y: {
                        title: { display: true, text: '' },
                        beginAtZero: true
                    }
                }
            };

            charts.airTempChart = createChart('airTempChart', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ñ—Ç—Ä—è', 'K', commonOptions);
            charts.processTempChart = createChart('processTempChart', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—É', 'K', commonOptions);
            charts.speedChart = createChart('speedChart', '–®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±–µ—Ä—Ç–∞–Ω–Ω—è', 'RPM', commonOptions);
            charts.torqueChart = createChart('torqueChart', '–ö—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç', 'Nm', commonOptions);
            charts.wearChart = createChart('wearChart', '–ó–Ω–æ—Å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É', 'units', commonOptions);
            charts.powerChart = createChart('powerChart', '–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å', 'W', commonOptions);
            charts.tempDiffChart = createChart('tempDiffChart', '–†—ñ–∑–Ω–∏—Ü—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä', 'K', commonOptions);

            console.log('–ì—Ä–∞—Ñ—ñ–∫–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ');
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞
        function createChart(canvasId, title, unit, options) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error('Canvas element –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ:', canvasId);
                return null;
            }

            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const chartOptions = { ...options };
            chartOptions.scales.y.title.text = unit;

            return new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: title,
                        data: [],
                        borderColor: colors.primary,
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });
        }

        const userRole = "{{ user.role }}";

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ/–ø–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —ñ—Å—Ç–æ—Ä—ñ—ó
        if (userRole === 'analyst' || userRole === 'admin') {
            document.getElementById('history-panel').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
        async function loadHistory() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;

            if (!start || !end) {
                alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏");
                return;
            }

            // –ó—É–ø–∏–Ω—è—î–º–æ Live –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–∑–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–æ–∫–µ—Ç –∞–±–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ –π–æ–≥–æ)
            if (ws) ws.close();
            document.getElementById('connection-status').textContent = '–†–µ–∂–∏–º —ñ—Å—Ç–æ—Ä—ñ—ó';
            document.getElementById('connection-status').className = 'connection-status status-warning';

            try {
                // –ó–∞–ø–∏—Ç –∑ –¥–∞—Ç–∞–º–∏
                const response = await fetch(`/api/device/${deviceUid}/charts?start_date=${start}&end_date=${end}`);
                const data = await response.json();

                if (data.charts) {
                    updateAllCharts(data.charts);
                }
            } catch (e) {
                console.error(e);
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó");
            }
        }

        // –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ Live —Ä–µ–∂–∏–º—É
        function resetToLive() {
            window.location.reload(); // –ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π —Å–ø–æ—Å—ñ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤—Å–µ —è–∫ –±—É–ª–æ
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è
        function updateAllCharts(chartsData) {
            const chartMapping = {
                'air_temp': 'airTempChart',
                'process_temp': 'processTempChart',
                'rotational_speed': 'speedChart',
                'torque': 'torqueChart',
                'tool_wear': 'wearChart',
                'power': 'powerChart',
                'temp_difference': 'tempDiffChart'
            };

            for (const [apiKey, chartName] of Object.entries(chartMapping)) {
                if (chartsData[apiKey] && charts[chartName]) {
                    const chart = charts[chartName];

                    // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ
                    chart.data.labels = [];
                    chart.data.datasets[0].data = [];

                    // –ó–∞–ª–∏–≤–∞—î–º–æ –Ω–æ–≤—ñ
                    chartsData[apiKey].data.forEach(point => {
                        chart.data.labels.push(new Date(point.x).toLocaleString());
                        chart.data.datasets[0].data.push(point.y);
                    });

                    chart.update();
                }
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function () {
            console.log('–°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
            loadInitialChartsData();
            connectWebSocket();
            updateScenarioDisplay(currentScenario);
        });
    </script>
</body>

</html>